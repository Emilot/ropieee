#!/bin/bash
# $RP_BEGIN_HEADER$ --------------------------------------------
#
# Copyright (C) 2017 RoPieee
#
# $RP_END_HEADER$ ----------------------------------------------

CONF=/opt/RoPieee/conf
LIB=/opt/RoPieee/lib

FILE=$1
if [ -n "$FILE" -a  ! -r "$FILE" ]
then
   echo "can't read file"
   exit 1
fi

if [ -n "$FILE" ]
then
   cat $FILE | sed s/\'// | sed s/\'// > /etc/ropieee.conf
   #cp $FILE /etc/ropieee.conf
fi

# so let's load the new configuration
. /etc/ropieee.conf

# set the hostname
echo $rp_hostname > /etc/hostname

# configure audio
if [ "$rp_audio" = "ropieee-no-hat" ]
then
   echo "no audio HAT configured"
   sed -i '/dtoverlay=/d' /boot/config.txt
else
   echo "configuring audio HAT $rp_audio"
   sed -i '/dtoverlay=/d' /boot/config.txt
   echo -e "\ndtoverlay=$rp_audio" >> /boot/config.txt
fi

if [ "$rp_audio_usb" = "1" ]
then
   echo "configuring USB audio"
   $LIB/enable_usb_audio
else
   $LIB/disable_usb_audio
fi

# disable onboard audio
if [ $( grep -c 'dtparam=audio=off' /boot/config.txt ) -eq 0 ]
then
   echo "dtparam=audio=off" >> /boot/config.txt
fi

# configure boot delay
if [ $( grep -c 'boot_delay=' /boot/config.txt ) -eq 0 ]
then
   echo "boot_delay=5" >> /boot/config.txt
fi

# configure timezone
TIMEZONE="/usr/share/zoneinfo/${rp_timezone}"
echo "configuring timezone"
if [ -f $TIMEZONE ]
then
   ln -sf $TIMEZONE /etc/localtime
fi

# configure touchscreen
if [ "$rp_touchscreen_detected" = "1" ]
then
   echo "configuring touchscreen"

   sed -i 's/ROON_DEFAULT_ZONE=.*/ROON_DEFAULT_ZONE='"$rp_touchscreen_zone"/ /etc/ropieee-remote.conf

   if [ "$rp_touchscreen_orientation" = "rotated" ]
   then
	$LIB/set_touchscreen_orient_rotated
   else
	$LIB/set_touchscreen_orient_default
   fi

   # enable the touchscreen only when the default zone has been set
   if [ "$rp_touchscreen_zone" != "unknown" ]
   then
      systemctl enable ropieee-touchui
   fi
fi

systemctl daemon-reload

# ok here we go!
if [ -n "$FILE" ]
then
   echo "Configure finished. Rebooting!!!"
   sleep 1
   sync; sync
   systemctl reboot
fi

exit 0 

